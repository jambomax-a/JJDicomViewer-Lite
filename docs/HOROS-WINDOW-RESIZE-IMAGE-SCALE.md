# HOROS-20240407 ウィンドウサイズ変更時の画像倍率調整の仕様

## 概要

このドキュメントは、HOROS-20240407のウィンドウサイズ変更時の画像倍率調整の仕様を解析したものです。

**最終更新**: 2025年12月

---

## 重要な発見

### setWindowFrameでの画像倍率の扱い

HOROS-20240407の`ViewerController.m:3092-3096`では、以下のコードが**コメントアウト**されています：

```objective-c
//		if( showWindow && [[NSUserDefaults standardUserDefaults] boolForKey: @"AlwaysScaleToFit"] == NO)
//		{
//			if( wasAlreadyVisible)
//				[imageView setScaleValue: scaleValue * [imageView frame].size.width / previousHeight];
//		}
```

これは、ウィンドウサイズが変更された時に、画像の倍率を自動的に調整するロジックですが、**コメントアウトされているため、通常は実行されません**。

### 画像読み込み時のscaleToFit

HOROS-20240407の`ViewerController.m:2478`では、新しいウィンドウを作成した時に`scaleToFit`が呼ばれます：

```objective-c
[imageView scaleToFit];
```

これは、**新しいウィンドウを作成した時のみ**実行されます。

### ウィンドウサイズ変更時の挙動

HOROS-20240407では、**ウィンドウサイズが変更されても、画像倍率は自動的に調整されません**。

ただし、以下の場合に倍率が変わる可能性があります：

1. **新しいウィンドウを作成した時**: `scaleToFit`が呼ばれる
2. **フルスクリーンから戻る時**: `scaleToFit`が呼ばれる（ViewerController.m:3589行目）
3. **特定の操作**: ユーザーが手動で倍率を変更した場合

## 結論

**HOROS-20240407では、ウィンドウサイズ変更時に画像倍率を自動調整しない**のが仕様です。

ただし、ユーザーの報告によると「OsiriXでは時々表示倍率変わる感じをもってる」とのことなので、以下の可能性があります：

1. **scaleToFitが呼ばれる場合**: 特定の操作（フルスクリーンから戻る、など）では`scaleToFit`が呼ばれる
2. **ユーザーの手動操作**: ユーザーが手動で倍率を変更した場合
3. **別のメカニズム**: OsiriXとHOROS-20240407で異なる仕様の可能性

## 現在のJava実装

現在のJava実装では、ウィンドウサイズ変更時に画像倍率を自動調整していないため、**HOROS-20240407の仕様に準拠しています**。

もし、画像が増える時に最初の方の画像の表示倍率が微妙に拡大されている場合、以下の原因が考えられます：

1. **ウィンドウサイズ変更**: タイリング時にウィンドウサイズが変更され、画像が拡大されている
2. **scaleToFitの呼び出し**: どこかで`scaleToFit`が呼ばれている可能性
3. **レイアウト調整**: レイアウトマネージャーによる自動調整

## 確認が必要な点

1. `ImageViewerPanel`でウィンドウサイズ変更時に何か処理をしているか
2. `ViewerController`でウィンドウサイズ変更時に何か処理をしているか
3. レイアウトマネージャーが自動的に画像サイズを調整していないか

もし、HOROS-20240407でも同様の挙動がある場合（ユーザーの報告によると「OsiriXでは時々表示倍率変わる感じをもってる」）、これは仕様に準拠している可能性があります。

---

## 参考実装箇所

### HOROS-20240407ソースコード

- **ViewerController.m:3092-3096**: `setWindowFrame`での画像倍率調整（コメントアウト）
- **ViewerController.m:2478**: 新しいウィンドウ作成時の`scaleToFit`
- **ViewerController.m:3589**: フルスクリーンから戻る時の`scaleToFit`

### Java実装

- **ImageViewerPanel.java**: 画像表示と倍率管理
- **ViewerController.java**: ウィンドウ管理

---

## 変更履歴

- 2025年12月: HOROS Window Resize関連ドキュメントを統合（2ファイル → 1ファイル）
- 2024年12月: 初期解析とドキュメント作成
