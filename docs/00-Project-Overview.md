# プロジェクト概要 - JJDICOMViewer

## 1. プロジェクトの目的

### 1.1 背景

Windows環境には、獣医師が使いやすいDICOMビューワーが不足しています。本プロジェクトは、以下の目的で開発されています：

1. **獣医向けDICOMビューワーの提供**
   - Windows環境での使い勝手の良いDICOMビューワー
   - 獣医師が慣れ親しんだ操作感の実現

2. **獣医向け電子カルテシステム（Vet-System）との連携**
   - Vet-Systemの一部として機能
   - テキストベースの連携を主とする

3. **スタンドアローン使用のサポート**
   - 単独でのDICOMビューワーとして使用可能
   - Vet-Systemなしでも動作

### 1.2 HOROSを選んだ理由

本プロジェクトは、HOROS-20240407のソースコードを詳細に解析し、Java Swingへの移植を行うことを目的としています。

**選択理由**：

1. **獣医師の慣れ親しんだ操作性**
   - 多くの獣医師がOsirix/HOROSを使用
   - 操作感の継承により学習コストを低減

2. **解説資料の存在**
   - HOROSに関する解説資料が存在
   - 開発・保守の参考資料が豊富

3. **成熟度の高いソースコード**
   - Osirixのソースは5年以上前のもの
   - HOROSはより成熟した実装

4. **移植の容易性**
   - 明確なアーキテクチャ
   - 機能の分離が適切

### 1.3 開発の経緯

1. **初期開発の試み**
   - 独自ロジックによる開発を開始
   - バグ取りがループし開発困難に

2. **再開発の決定**
   - HOROSの詳細な分析から再開発を決定
   - 実績のあるアーキテクチャを採用

3. **現在のアプローチ**
   - HOROSのソースコードを徹底的に解析
   - Java Swingへの移植として実装

## 2. 対象ユーザー

### 2.1 主なユーザー

- **獣医師**
  - 小動物病院の獣医師
  - 大学病院の獣医師
  - 画像診断を日常的に行う獣医師

### 2.2 使用環境

- **OS**: Windows 10/11
- **用途**: 
  - 獣医向け電子カルテシステム（Vet-System）との連携
  - スタンドアローンでのDICOM画像閲覧

## 3. 機能範囲

### 3.1 実装する機能

以下の機能を実装します：

1. **基本的なDICOMビューワー機能**
   - DICOMファイルの読み込み・表示
   - 画像操作（ズーム、パン、WL/WW調整）
   - キーボードショートカット（H/V/R/Lキー）

2. **DICOM通信機能**
   - C-STORE（画像送信）
   - C-FIND（検索）
   - C-MOVE（取得）

3. **PACS機能**
   - DICOMサーバー（SCP）
   - 自動ルーティング
   - スケジュール機能

4. **画像解析機能**
   - ROI（17種類）
   - 測定機能
   - 統計計算

5. **MPR/3D画像作成機能**（オプション）
   - MPR（Multi-Planar Reconstruction）
   - Volume Rendering
   - Curved MPR

6. **AI画像解析機能**（オプション）
   - AIモデルの統合
   - セグメンテーション
   - 検出・分類

7. **データベース管理**
   - SQLiteデータベース
   - 検索機能
   - メタデータ管理

8. **CD/DVD自動インポート・作成機能**
   - CD/DVDドライブの自動検出
   - DICOMファイルの自動スキャン
   - 自動インポート機能
   - お渡し用CD/DVD作成機能
   - Vet-Systemとの連携（共通ライブラリ）

9. **追加機能**
   - 圧縮/展開機能（JPEG/JPEG2000、CD/DVD作成時等）
   - 匿名化機能（CD/DVD作成時等）
   - レポート機能（Structured Report含む）
   - 印刷機能（DICOM Print SCU）
   - WADO機能（Web経由での画像取得）
   - ログ機能
   - ヒストグラム機能（オプション）

10. **設定管理**
   - DICOMデータ保存フォルダの設定
   - DB保存フォルダの設定
   - 国際化（日本語/英語）

### 3.2 除外する機能

以下の機能は、本プロジェクトでは**実装しません**：

1. **HOROS/OsirixのDB共通性によるインポート・エクスポート連携**
   - 理由: Vet-Systemとの連携が主目的
   - 代替: テキストベースの連携を使用

2. **Bonjour機能**
   - 理由: Vet-Systemとの連携が主目的
   - 代替: 明示的な設定による接続

3. **Core Dataの使用**
   - 理由: Java環境では使用不可
   - 代替: SQLiteデータベースを使用

## 4. Vet-Systemとの連携

### 4.1 連携方式

Vet-Systemとの連携は、**テキストベース**を主とします：

1. **外部起動方式**（推奨）
   - Vet-SystemからJJDICOMViewerを外部アプリとして起動
   - 患者情報やDICOMリンク情報を引数またはファイルで渡す
   - JJDICOMViewerで画像を表示・操作

2. **ファイルベースの連携**
   - 共有フォルダを使用
   - ファイルの監視による自動読み込み

3. **API連携**（将来の拡張）
   - REST APIによる連携
   - JSON形式でのデータ交換

4. **データベース連携**（将来の拡張）
   - Vet-Systemのデータベースへの接続
   - 患者情報の取得

### 4.2 連携データ

以下のデータを連携します：

1. **患者情報**
   - 患者ID（ownerId, patientId）
   - 患者名
   - 生年月日

2. **検査情報**
   - 検査日時（consultationDate）
   - 記録ID（recordId）
   - DICOMリンク情報

3. **画像情報**
   - DICOMファイルのパス
   - 画像メタデータ
   - Study Instance UID
   - Series Instance UID

### 4.3 Vet-System側の修正について

**重要な注意事項**:

Vet-SystemのDICOMビューワー部分も仕様からの独自ロジックで実装されています。JJDICOMViewerをHOROSベースで実装する場合、Vet-System側のビューワーも修正が必要になる可能性があります。

**修正が必要な可能性がある箇所**:

1. **DICOMビューワー画面**
   - JJDICOMViewer起動ボタンの追加
   - 患者情報の引き渡し機能
   - DICOMリンク情報の引き渡し機能

2. **API**
   - JJDICOMViewer用のAPIエンドポイント
   - データ形式の統一

3. **操作性**
   - 操作性の差異を最小限に抑える
   - ユーザーへの説明・マニュアルの更新

詳細は[Vet-System連携と操作性の継承](14-Vet-System-Integration.md)を参照してください。

## 5. 技術スタック

### 5.1 開発言語・フレームワーク

- **Java 21**: メイン開発言語
- **Java Swing**: UIフレームワーク
  - **選択理由**: 
    - マルチプラットフォーム対応（Windows、macOS、Linuxでそのまま使用可能）
    - デスクトップPCでのクロスプラットフォーム開発が容易
    - JavaFXはインストーラー作成時に苦労するため除外
- **Java2D**: 画像レンダリング

### 5.2 主要ライブラリ

- **dcm4che-5.34.1**: DICOM処理
- **SQLite JDBC**: データベース
- **Jackson**: JSON/YAML処理
- **SLF4J/Logback**: ロギング

### 5.3 オプションライブラリ

- **JOGL**: 3Dレンダリング（MPR/3D機能用）
- **ONNX Runtime**: AI推論（AI機能用）
- **TensorFlow Java**: AI推論（AI機能用）

## 6. プロジェクト構造

```
JJDicomViewer/
├── docs/                    # ドキュメント
│   ├── 00-Project-Overview.md
│   ├── 01-Architecture-Overview.md
│   ├── 02-DICOM-File-Processing.md
│   ├── ...
│   └── README.md
├── horos-20240407/          # HOROSソースコード（参考）
├── src/
│   └── main/
│       └── java/
│           └── com/
│               └── jjdicomviewer/
│                   ├── dicom/        # DICOM処理
│                   ├── database/     # データベース
│                   ├── ui/           # UIコンポーネント
│                   ├── pacs/         # PACS機能
│                   ├── analysis/     # 画像解析
│                   └── config/       # 設定管理
├── resources/
│   └── i18n/                # 国際化リソース
│       ├── messages_ja.properties
│       └── messages_en.properties
└── build.gradle.kts         # Gradleビルド設定
```

## 7. 開発方針

### 7.1 移植の方針

1. **機能の忠実な移植**
   - HOROSの機能を可能な限り再現
   - 操作感の継承

2. **マルチプラットフォーム対応**
   - Java Swingによるクロスプラットフォーム実装
   - Windows、macOS、Linuxで同一バイナリが動作
   - プラットフォーム固有の機能は最小限に

3. **Javaらしい実装**
   - Javaのベストプラクティスに従う
   - 適切な設計パターンの使用

4. **拡張性の確保**
   - Vet-Systemとの連携を考慮
   - 将来の機能追加に対応

### 7.2 品質管理

1. **テストの実施**
   - 単体テスト
   - 統合テスト
   - ユーザーテスト

2. **ドキュメントの整備**
   - コードコメント
   - APIドキュメント
   - ユーザーマニュアル

3. **エラーハンドリング**
   - 適切なエラー処理
   - ログの記録
   - ユーザーへの通知

## 8. 今後の展開

### 8.1 短期目標

1. **基本的なDICOMビューワーの実装**
   - 画像表示機能
   - 基本的な操作機能

2. **Vet-Systemとの連携**
   - テキストベースの連携
   - ファイルベースの連携

### 8.2 中期目標

1. **PACS機能の実装**
   - DICOMサーバー機能
   - 自動ルーティング

2. **画像解析機能の拡充**
   - ROI機能の完全実装
   - 測定機能の拡充

### 8.3 長期目標

1. **MPR/3D機能の実装**
   - MPR表示
   - Volume Rendering

2. **AI機能の統合**
   - AIモデルの統合
   - 自動解析機能

## 9. 関連プロジェクト

### 9.1 Vet-System

獣医向け電子カルテシステム。本プロジェクトは、Vet-Systemの一部として機能します。

### 9.2 JJDICOMViewer-Lite

**位置づけ**: CD/DVD同梱用の簡易DICOMビューワー

**用途**:
- お渡し用のCD/DVD作成時に同梱する簡易ビューワー
- 患者へのDICOM画像の提供時に使用
- 軽量で起動が速い

**要件**:
- 軽量でコンパクトな実装
- インストール不要で実行可能（ポータブル）
- CD/DVDから直接実行可能
- 基本的な画像表示機能（ズーム、パン、WL/WW調整）
- 操作性はJJDICOMViewerと共通（JJDICOMViewer-Liteの実装を基準）

**操作性の共通化**:
- パンニング: 左クリック + ドラッグ（SHIFTキーが押されていない場合）
- ズーム: CTRL + マウスホイール
- Window Level/Width: SHIFT + 左クリック + ドラッグ
- スライス移動: 通常のマウスホイール（CTRLが押されていない場合）

**実装方針**:
- 同じフォルダ階層に配置
- 操作性をJJDICOMViewerと統一
- 最小限の機能に絞る（ROI、PACS機能等は除外）

## 10. ライセンス

HOROSはLGPLライセンスの下で公開されています。本プロジェクトも同様のライセンスを遵守します。

## 11. 参考資料

- HOROS公式サイト: https://www.horosproject.org/
- HOROSソースコード: horos-20240407/
- dcm4cheドキュメント: https://www.dcm4che.org/
- DICOM標準: https://www.dicomstandard.org/

